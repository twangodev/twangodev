name: Build and Deploy

on:
  push:
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '0 */3 * * *'

jobs:
  metrics:
    runs-on: ubuntu-latest
    steps:
      - name: GitHub Metrics
        uses: lowlighter/metrics@65836723097537a54cd8eb90f61839426b4266b6 # v3.34
        with:
          token: ${{ secrets.METRICS_TOKEN }}
          user: ${{ github.repository_owner }}
          filename: github-metrics.svg
          output_action: none
          base: header, activity, community, repositories, metadata
          repositories_affiliations: owner, collaborator, organization_member
          repositories: 1000
          repositories_batch: 25
          plugin_languages: yes
          plugin_languages_limit: 8
          plugin_languages_sections: most-used
          plugin_languages_categories: markup, programming
          plugin_languages_other: yes

      - name: WakaTime & Last.fm Metrics
        uses: lowlighter/metrics@65836723097537a54cd8eb90f61839426b4266b6 # v3.34
        with:
          token: NOT_NEEDED
          user: ${{ github.repository_owner }}
          filename: github-metrics-sidebar.svg
          output_action: none
          base: ''
          plugin_wakatime: yes
          plugin_wakatime_token: ${{ secrets.WAKATIME_TOKEN }}
          plugin_wakatime_sections: time, projects, projects-graphs, languages, languages-graphs, editors, os
          plugin_wakatime_days: 7
          plugin_music: yes
          plugin_music_provider: lastfm
          plugin_music_mode: recent
          plugin_music_user: ${{ vars.LASTFM_USER }}
          plugin_music_token: ${{ secrets.LASTFM_TOKEN }}
          plugin_music_limit: 4

      - name: Upload Metrics
        uses: actions/upload-artifact@v4
        with:
          name: metrics
          path: /metrics_renders/

  arc-gen:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Install uv
        uses: astral-sh/setup-uv@v7
      - name: Install Dependencies
        run: uv sync
        working-directory: ./arc-gen
      - name: Run Python Script
        run: uv run main.py
        working-directory: ./arc-gen
        env:
          OUTPUT: ../globe-arcs.json
          FLIGHT_RADAR_USERNAME: ${{ vars.FLIGHT_RADAR_USERNAME }}
      - name: Upload Arc Data
        uses: actions/upload-artifact@v4
        with:
          name: arc-data
          path: globe-arcs.json

  build:
    needs: [metrics, arc-gen]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Download Metrics
        uses: actions/download-artifact@v4
        with:
          name: metrics
          path: static/metrics/
      - name: Download Arc Data
        uses: actions/download-artifact@v4
        with:
          name: arc-data
          path: static/
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
      - name: Install Dependencies
        run: bun install --frozen-lockfile
      - name: Build
        run: bun run build
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: build

  deploy:
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
