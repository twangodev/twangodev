name: Build and Deploy

on:
  push:  # Run on all pushes to any branch
  pull_request:  # Run on all pull requests
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight UTC

jobs:
  metrics:
    runs-on: ubuntu-latest
    steps:
      - name: GitHub Metrics
        uses: lowlighter/metrics@65836723097537a54cd8eb90f61839426b4266b6 # v3.34
        with:
          token: ${{ secrets.METRICS_TOKEN }}
          user: ${{ github.repository_owner }}
          filename: github-metrics.svg
          output_action: none
          base: header, activity, community, repositories, metadata
          plugin_languages: yes
          plugin_languages_limit: 8
          plugin_languages_sections: most-used
          plugin_languages_categories: markup, programming
          plugin_languages_other: yes

      - name: Last.fm Metrics
        uses: lowlighter/metrics@65836723097537a54cd8eb90f61839426b4266b6 # v3.34
        with:
          token: NOT_NEEDED
          user: ${{ github.repository_owner }}
          filename: github-metrics-music.svg
          output_action: none
          base: ""
          plugin_music: yes
          plugin_music_provider: lastfm
          plugin_music_mode: top
          plugin_music_top_type: tracks
          plugin_music_time_range: short
          plugin_music_user: ${{ vars.LASTFM_USER }}
          plugin_music_token: ${{ secrets.LASTFM_TOKEN }}
          plugin_music_limit: 4

      - name: Upload Metrics
        uses: actions/upload-artifact@v4
        with:
          name: metrics
          path: /metrics_renders/

  build:
    needs: metrics
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Download Metrics
        uses: actions/download-artifact@v4
        with:
          name: metrics
          path: public/metrics/
      - name: Install uv
        uses: astral-sh/setup-uv@v7
      - name: Install Dependencies
        run: uv sync
        working-directory: ./arc-gen
      - name: Run Python Script
        run: uv run main.py
        working-directory: ./arc-gen
        env:
          OUTPUT: ../public/globe-arcs.json
          FLIGHT_RADAR_USERNAME: ${{ vars.FLIGHT_RADAR_USERNAME }}
      - name: Install, build, and upload your site
        uses: withastro/action@v5

  deploy:
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
